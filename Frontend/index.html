<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>CryptoZombies front-end</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-image: url('./images/zombiewall2.jpg');
        background-size: cover;
        background-position: center;
        background-attachment: fixed;
        font-family: 'Roboto', sans-serif;
        color: #f5f5f5; /* Light text color for readability */
        margin: 0;
        padding: 0;
      }

      /* Two-color palette for simplicity and elegance */
      :root {
        --primary-color: #2b2d31; /* Deep charcoal for buttons and containers */
        --accent-color: #dfd87288; /* Electric blue for accents */
        --text-color: #f5f5f5; /* Light text for readability */
      }

      h1 {
        text-align: center;
        margin-top: 20px;
        color: var(--accent-color);
        /* text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.7); */
      }

      .container {
        margin-top: 40px;
        background-color: rgba(
          43,
          45,
          49,
          0.85
        ); /* Transparent deep charcoal */
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.5);
      }

      /* Card styling */
      .card {
        margin-bottom: 20px;
        border-radius: 10px;
        background-color: var(--primary-color); /* Deep charcoal */
        color: var(--text-color);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
        transition: transform 0.2s, box-shadow 0.3s;
      }

      .card:hover {
        transform: scale(1.05);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.8);
      }

      /* Image in the card */
      .card-img-top {
        width: 100%;
        height: 150px;
        object-fit: contain;
        border-radius: 10px 10px 0 0;
      }

      /* Buttons with same accent color */
      .btn {
        margin: 10px 0;
        border-radius: 30px;
        padding: 10px 20px;
        font-weight: bold;
        background-color: var(--accent-color); /* Electric blue */
        color: white;
        border: none;
        transition: background-color 0.3s, box-shadow 0.3s;
      }

      .btn:hover {
        background-color: #1663a3; /* Slightly darker shade of electric blue */
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
      }

      #zombies {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
      }

      #txStatus {
        text-align: center;
        color: black;
        /* text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.7); */
      }

      .action-buttons {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 15px;
      }

      /* Card body text styling */
      .card-body {
        text-align: center;
        font-size: 1.1rem;
        color: var(--text-color);
      }
    </style>

    <script
      language="javascript"
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"
    ></script>
    <script
      language="javascript"
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.2.7-rc.0/web3.min.js"
    ></script>
    <script
      language="javascript"
      type="text/javascript"
      src="cryptozombies_abi.js"
    ></script>
  </head>

  <body>
    <div class="container">
      <h1 class="my-4" style="color: rgba(201, 240, 116, 0.764)">
        CryptoZombies Dashboard
      </h1>
      <div id="txStatus" class="alert alert-info"></div>
      <div id="zombies" class="row"></div>

      <div class="action-buttons">
        <button class="btn btn-primary showZombieButton">Show Zombies</button>
        <button class="btn btn-success createzombieButton">
          Create Zombie
        </button>
        <button class="btn btn-warning levelupButton">Level Up</button>
        <!-- <button class="btn btn-danger feedZombieButton">Feed on Kitty</button> -->
        <button class="btn btn-info showKittiesButton">Show Kitties</button>

        <button class="btn btn-secondary transferZombieButton">
          Transfer Zombie
        </button>
        <button class="btn btn-dark battleZombieButton">Attack Zombie</button>
        <button class="btn btn-info renameZombieButton">Rename Zombie</button>
        <button class="btn btn-danger transferOwnershipButton">
          Transfer Ownership
        </button>
        <button class="btn btn-secondary leveldownButton">Level Down</button>
        <button class="btn btn-secondary changeDnaButton">Change DNA</button>
        <button class="btn btn-info leaderboardButton">Show Leaderboard</button>
        <button class="btn btn-info createKittyButton">Create Kitty</button>
        <button class="btn btn-info showZombieCountButton">
          Show Zombie Count
        </button>
        <!-- <button class="btn btn-info showKittyContractAddressButton">
          Show Kitty Contract Address
        </button> -->
      </div>
    </div>

    <script>
      var zombieOwnership;
      var userAccount;
      var kittyContract;
      var zombieFeedingContract;
      const KittyContractABI = [
        {
          constant: true,
          inputs: [{ name: '_id', type: 'uint256' }],
          name: 'getKitty',
          outputs: [
            { name: 'name', type: 'string' }, // Added name as a return value
            { name: 'isGestating', type: 'bool' },
            { name: 'isReady', type: 'bool' },
            { name: 'cooldownIndex', type: 'uint256' },
            { name: 'nextActionAt', type: 'uint256' },
            { name: 'siringWithId', type: 'uint256' },
            { name: 'birthTime', type: 'uint256' },
            { name: 'matronId', type: 'uint256' },
            { name: 'sireId', type: 'uint256' },
            { name: 'generation', type: 'uint256' },
            { name: 'genes', type: 'uint256' },
          ],
          payable: false,
          stateMutability: 'view',
          type: 'function',
        },
        {
          constant: true,
          inputs: [],
          name: 'getKittyCount',
          outputs: [{ name: '', type: 'uint256' }],
          payable: false,
          stateMutability: 'view',
          type: 'function',
        },
        {
          constant: false,
          inputs: [{ name: '_name', type: 'string' }], // Changed to take the kitty's name
          name: 'createKitty',
          outputs: [],
          payable: false,
          stateMutability: 'nonpayable',
          type: 'function',
        },
      ];

      const ZombieFeedingABI = [
        {
          constant: true,
          inputs: [
            {
              name: '',
              type: 'uint256',
            },
          ],
          name: 'zombies',
          outputs: [
            {
              name: 'name',
              type: 'string',
            },
            {
              name: 'dna',
              type: 'uint256',
            },
            {
              name: 'level',
              type: 'uint32',
            },
            {
              name: 'readyTime',
              type: 'uint32',
            },
            {
              name: 'winCount',
              type: 'uint16',
            },
            {
              name: 'lossCount',
              type: 'uint16',
            },
          ],
          payable: false,
          stateMutability: 'view',
          type: 'function',
        },
        {
          constant: true,
          inputs: [
            {
              name: '',
              type: 'uint256',
            },
          ],
          name: 'zombieToOwner',
          outputs: [
            {
              name: '',
              type: 'address',
            },
          ],
          payable: false,
          stateMutability: 'view',
          type: 'function',
        },
        {
          constant: true,
          inputs: [],
          name: 'kittyContract',
          outputs: [
            {
              name: '',
              type: 'address',
            },
          ],
          payable: false,
          stateMutability: 'view',
          type: 'function',
        },
        {
          constant: false,
          inputs: [],
          name: 'renounceOwnership',
          outputs: [],
          payable: false,
          stateMutability: 'nonpayable',
          type: 'function',
        },
        {
          constant: false,
          inputs: [
            {
              name: '_name',
              type: 'string',
            },
          ],
          name: 'createRandomZombie',
          outputs: [],
          payable: false,
          stateMutability: 'nonpayable',
          type: 'function',
        },
        {
          constant: true,
          inputs: [],
          name: 'owner',
          outputs: [
            {
              name: '',
              type: 'address',
            },
          ],
          payable: false,
          stateMutability: 'view',
          type: 'function',
        },
        {
          constant: true,
          inputs: [],
          name: 'isOwner',
          outputs: [
            {
              name: '',
              type: 'bool',
            },
          ],
          payable: false,
          stateMutability: 'view',
          type: 'function',
        },
        {
          constant: false,
          inputs: [
            {
              name: 'newOwner',
              type: 'address',
            },
          ],
          name: 'transferOwnership',
          outputs: [],
          payable: false,
          stateMutability: 'nonpayable',
          type: 'function',
        },
        {
          anonymous: false,
          inputs: [
            {
              indexed: false,
              name: 'zombieId',
              type: 'uint256',
            },
            {
              indexed: false,
              name: 'name',
              type: 'string',
            },
            {
              indexed: false,
              name: 'dna',
              type: 'uint256',
            },
          ],
          name: 'NewZombie',
          type: 'event',
        },
        {
          anonymous: false,
          inputs: [
            {
              indexed: true,
              name: 'previousOwner',
              type: 'address',
            },
            {
              indexed: true,
              name: 'newOwner',
              type: 'address',
            },
          ],
          name: 'OwnershipTransferred',
          type: 'event',
        },
        {
          constant: false,
          inputs: [
            {
              name: '_address',
              type: 'address',
            },
          ],
          name: 'setKittyContractAddress',
          outputs: [],
          payable: false,
          stateMutability: 'nonpayable',
          type: 'function',
        },
        {
          constant: true,
          inputs: [],
          name: 'getKittyContractAddress',
          outputs: [
            {
              name: '',
              type: 'address',
            },
          ],
          payable: false,
          stateMutability: 'view',
          type: 'function',
        },
        {
          constant: false,
          inputs: [
            {
              name: '_zombieId',
              type: 'uint256',
            },
            {
              name: '_kittyId',
              type: 'uint256',
            },
          ],
          name: 'feedOnKitty',
          outputs: [],
          payable: false,
          stateMutability: 'nonpayable',
          type: 'function',
        },

        {
          anonymous: false,
          inputs: [
            {
              indexed: true,
              name: 'zombieId',
              type: 'uint256',
            },
            {
              indexed: true,
              name: 'kittyId',
              type: 'uint256',
            },
          ],
          name: 'FeedOnKitty',
          type: 'event',
        },
        // Event: ZombieFed
        {
          anonymous: false,
          inputs: [
            {
              indexed: false,
              name: 'zombieId',
              type: 'uint256',
            },
            {
              indexed: false,
              name: 'newDna',
              type: 'uint256',
            },
          ],
          name: 'ZombieFed',
          type: 'event',
        },
        // Event: LogZombiesLength
        {
          anonymous: false,
          inputs: [
            {
              indexed: false,
              name: 'length',
              type: 'uint256',
            },
          ],
          name: 'LogZombiesLength',
          type: 'event',
        },
        // Event: LogZombieOwner
        {
          anonymous: false,
          inputs: [
            {
              indexed: false,
              name: 'owner',
              type: 'address',
            },
          ],
          name: 'LogZombieOwner',
          type: 'event',
        },
      ];

      const zombieOwnershipAddress =
        '0x3a6BDc1c2FAee4A99FB5a494a6b604E76C6fd73f'; // Replace with actual ZombieOwnership contract address
      const kittyContractAddress = '0xb1bc86dd5875ebD4963D0DF43A7A2Ac6a7665197'; // Replace with actual KittyContract address
      const zombieFeedingAddress = '0x9028bB0bCdD4e6440f2339Ac13f3379EC2EBb375'; // Replace with actual ZombieFeeding contract address

      // Define all button references
      const showZombieButton = document.querySelector('.showZombieButton');
      const createzombieButton = document.querySelector('.createzombieButton');
      const levelupButton = document.querySelector('.levelupButton');
      // const feedZombieButton = document.querySelector('.feedZombieButton');
      const transferZombieButton = document.querySelector(
        '.transferZombieButton',
      );
      const transferOwnershipButton = document.querySelector(
        '.transferOwnershipButton',
      );
      const battleZombieButton = document.querySelector('.battleZombieButton');
      const leveldownButton = document.querySelector('.leveldownButton');
      const renameZombieButton = document.querySelector('.renameZombieButton');
      const createKittyButton = document.querySelector('.createKittyButton'); // Create Kitty Button
      const showKittiesButton = document.querySelector('.showKittiesButton');
      const changeDnaButton = document.querySelector('.changeDnaButton');
      const leaderboardButton = document.querySelector('.leaderboardButton');
      const showZombieCountButton = document.querySelector(
        '.showZombieCountButton',
      );
      // const showKittyContractAddressButton = document.querySelector(
      //   '.showKittyContractAddressButton',
      // );

      async function checkNetwork() {
        const chainId = await ethereum.request({ method: 'eth_chainId' });
        const expectedChainId = '0x539';

        if (chainId !== expectedChainId) {
          try {
            await ethereum.request({
              method: 'wallet_switchEthereumChain',
              params: [{ chainId: expectedChainId }],
            });
            console.log('Switched to Ganache network');
          } catch (error) {
            if (error.code === 4902) {
              try {
                await ethereum.request({
                  method: 'wallet_addEthereumChain',
                  params: [
                    {
                      chainId: expectedChainId,
                      chainName: 'Ganache Local',
                      rpcUrls: ['http://127.0.0.1:7545'], // Ganache RPC URL
                      nativeCurrency: {
                        name: 'Ether',
                        symbol: 'ETH',
                        decimals: 18,
                      },
                      blockExplorerUrls: null,
                    },
                  ],
                });
                console.log('Added and switched to Ganache network');
              } catch (addError) {
                console.error(addError);
              }
            } else {
              console.error(error);
            }
          }
        } else {
          console.log('Already on the correct network (Ganache)');
        }
      }

      async function checkZombieExists(zombieId) {
        const totalZombies = await zombieOwnership.methods
          .getZombiesCount()
          .call();
        console.log('Total Zombies: ', totalZombies);

        if (zombieId >= totalZombies) {
          console.error('Zombie ID out of bounds');
          return false;
        }
        return true;
      }

      async function startApp() {
        const accounts = await web3.eth.getAccounts();
        const balance1 = await web3.eth.getBalance(accounts[0]);
        const balance2 = await web3.eth.getBalance(accounts[1]);

        if (balance2 > 0) {
          userAccount = accounts[1]; // Use Account 2 if it has ETH
        } else if (balance1 > 0) {
          userAccount = accounts[0]; // Fallback to Account 1
        } else {
          alert('Neither account has ETH. Please fund your account.');
          return;
        }

        if (!userAccount) {
          $('#txStatus').text(
            'MetaMask is connected but no account selected with balance.',
          );
          return;
        }

        // Initializing the ZombieOwnership contract
        zombieOwnership = new web3.eth.Contract(
          cryptoZombiesABI,
          zombieOwnershipAddress,
        );

        kittyContract = new web3.eth.Contract(
          KittyContractABI,
          kittyContractAddress,
        );

        zombieFeedingContract = new web3.eth.Contract(
          ZombieFeedingABI,
          zombieFeedingAddress,
        );

        const currentKittyContractAddress = await zombieFeedingContract.methods
          .getKittyContractAddress()
          .call();
        console.log('Kitty Contract Address:', currentKittyContractAddress);

        console.log('Web3 Version', Web3.version);

        const ownerAddress = await zombieFeedingContract.methods.owner().call();
        console.log('Contract owner:', ownerAddress);
        console.log('Current user:', userAccount);

        $('#txStatus').text(
          userAccount === ownerAddress
            ? 'You are the contract owner.'
            : 'You are not the contract owner.',
        );

        // zombieFeedingContract.events.LogZombiesLength(
        //   {},
        //   function (error, event) {
        //     if (error) {
        //       console.error('Error in Zombies Length', error);
        //     } else {
        //       console.log('Zombies Length', event.returnValues);
        //     }
        //   },
        // );

        // zombieFeedingContract.events
        //   .LogZombieOwner({})
        //   .on('data', function (event) {
        //     console.log('LogZombieOwner event:', event.returnValues);
        //   })
        //   .on('error', function (error) {
        //     console.error('Error in LogZombieOwner event:', error);
        //   });

        // zombieFeedingContract.events.FeedOnKitty({}, function (error, event) {
        //   if (error) {
        //     console.error('Error in FeedOnKitty event:', error);
        //   } else {
        //     console.log('FeedOnKitty event:', event.returnValues);
        //   }
        // });

        await setKittyAddress();

        const isOwner = await zombieFeedingContract.methods
          .isOwner()
          .call({ from: userAccount });
        console.log('Is user the owner?', isOwner);
        $('#txStatus').text(
          isOwner
            ? 'You are the contract owner.'
            : 'You are not the contract owner.',
        );

        // Listen for transfer events to update zombie list
        zombieOwnership.events
          .Transfer({ filter: { _to: userAccount } })
          .on('data', function (event) {
            getZombiesByOwner(userAccount).then(displayZombies);
          })
          .on('error', console.error);
      }

      // Feed on Kitty function
      // Feed on Kitty function
      // async function feedOnKitty(zombieId, kittyId) {
      //   console.log('feedOnKitty function called');
      //   console.log('Zombie ID:', zombieId);
      //   console.log('Kitty ID:', kittyId);

      //   $('#txStatus').text('Checking zombie ownership...');

      //   const userAccount = (
      //     await ethereum.request({ method: 'eth_accounts' })
      //   )[0];
      //   console.log('User account retrieved from MetaMask:', userAccount);

      //   // Check if the zombie with this ID exists
      //   console.log('Checking if zombie exists...');
      //   if (!(await checkZombieExists(zombieId))) {
      //     console.log('Zombie does not exist. Zombie ID out of bounds.');
      //     $('#txStatus').text('Zombie ID out of bounds.');
      //     return;
      //   }
      //   console.log('Zombie exists. Proceeding to next step.');

      //   // Use zombieOwnership contract to check the owner of the zombie
      //   const zombieOwner = await zombieOwnership.methods
      //     .zombieToOwner(zombieId)
      //     .call();
      //   console.log('Zombie Owner:', zombieOwner);
      //   console.log('Zombie ID:', zombieId);
      //   console.log('Current User:', userAccount);

      //   if (zombieOwner.toLowerCase() !== userAccount.toLowerCase()) {
      //     console.log('Ownership check failed. User does not own this zombie.');
      //     $('#txStatus').text('You must own this zombie to feed on a kitty.');
      //     return;
      //   }
      //   console.log('Ownership check passed.');

      //   // Fetch kitty details and log the data
      //   console.log('Fetching kitty details...');
      //   try {
      //     const kittyData = await kittyContract.methods
      //       .getKitty(kittyId)
      //       .call();
      //     console.log('Kitty Data:', kittyData); // Log the result of getKitty

      //     if (!kittyData) {
      //       console.error('Invalid Kitty data returned');
      //       $('#txStatus').text('Invalid Kitty data.');
      //       return;
      //     }
      //   } catch (error) {
      //     console.error('Error fetching kitty data:', error);
      //     $('#txStatus').text('Error fetching kitty data.');
      //     return;
      //   }
      //   console.log('Kitty data fetched successfully.');

      //   // Proceed with feeding on kitty
      //   console.log('Proceeding to feed zombie on kitty...');
      //   $('#txStatus').text('Feeding zombie on a kitty...');

      //   try {
      //     console.log('Estimating gas for feedOnKitty transaction...');
      //     const gasEstimate = await zombieFeedingContract.methods
      //       .feedOnKitty(zombieId, kittyId)
      //       .estimateGas({ from: userAccount });
      //     console.log('Gas estimate:', gasEstimate);

      //     console.log('Sending feedOnKitty transaction...');
      //     await zombieFeedingContract.methods
      //       .feedOnKitty(zombieId, kittyId)
      //       .send({ from: userAccount, gas: gasEstimate });
      //     console.log(
      //       'Transaction successful! Zombie successfully fed on kitty.',
      //     );
      //     $('#txStatus').text('Zombie successfully fed on a kitty!');
      //   } catch (error) {
      //     console.error('Error during feedOnKitty:', error);
      //     $('#txStatus').text(`Error: ${error.message}`);
      //   }
      // }

      async function showZombieCount() {
        try {
          const zombieCount = await zombieOwnership.methods
            .getZombiesCount()
            .call();
          $('#txStatus').text('Total Zombies: ' + zombieCount);
        } catch (error) {
          console.error('Error fetching zombie count:', error);
          $('#txStatus').text('Error fetching zombie count: ' + error.message);
        }
      }

      // async function showKittyContractAddress() {
      //   try {
      //     const kittyContractAddress = await zombieFeedingContract.methods
      //       .getKittyContractAddress()
      //       .call();
      //     $('#txStatus').text(
      //       'Kitty Contract Address: ' + kittyContractAddress,
      //     );
      //   } catch (error) {
      //     console.error('Error fetching Kitty contract address:', error);
      //     $('#txStatus').text(
      //       'Error fetching Kitty contract address: ' + error.message,
      //     );
      //   }
      // }

      // Transfer Zombie function
      function transferZombie(zombieId, recipient) {
        $('#txStatus').text('Transferring zombie...');
        return zombieOwnership.methods
          .transferFrom(userAccount, recipient, zombieId)
          .send({ from: userAccount })
          .on('receipt', function (receipt) {
            $('#txStatus').text('Zombie transferred!');
            getZombiesByOwner(userAccount).then(displayZombies);
          })
          .on('error', function (error) {
            $('#txStatus').text(error.message);
          });
      }

      function displayZombies(ids) {
        $('#zombies').empty(); // Clear existing zombies
        if (ids.length === 0) {
          $('#txStatus').text('No zombies found for this account.');
          return;
        }

        ids.forEach(function (id) {
          getZombieDetails(id).then(function (zombie) {
            const zombieImage = `https://robohash.org/${zombie.dna}?set=set2&size=150x150`;
            $('#zombies').append(`
              <div class="col-4">
                <div class="zombie card">
                  <img src="${zombieImage}" class="card-img-top" alt="Zombie image">
                  <div class="card-body">
                    <ul class="list-unstyled">
                      <li>ID: ${id}</li>
                      <li>Name: ${zombie.name}</li>
                      <li>DNA: ${zombie.dna}</li>
                      <li>Level: ${zombie.level}</li>
                      <li>Wins: ${zombie.winCount}</li>
                      <li>Losses: ${zombie.lossCount}</li>
                      <li>Ready Time: ${zombie.readyTime}</li>
                    </ul>
                  </div>
                </div>
              </div>`);
          });
        });
      }

      async function displayLeaderboard() {
        $('#zombies').empty(); // Clear the existing content

        $('#txStatus').text('Loading leaderboard...');

        // Get all zombies owned by all users
        let allZombies = [];

        const totalZombies = await zombieOwnership.methods
          .getZombiesCount()
          .call();

        for (let i = 0; i < totalZombies; i++) {
          const zombie = await zombieOwnership.methods.zombies(i).call();
          allZombies.push({
            id: i,
            name: zombie.name,
            winCount: zombie.winCount,
            level: zombie.level,
          });
        }

        // Sort the zombies by win count (you can change this to level or other metrics)
        allZombies.sort((a, b) => b.winCount - a.winCount);

        // Display the top 10 zombies (you can modify this number)
        for (let i = 0; i < Math.min(allZombies.length, 10); i++) {
          const zombie = allZombies[i];
          $('#zombies').append(`
      <div class="col-4">
        <div class="zombie card">
          <div class="card-body">
            <h5 class="card-title">Rank #${i + 1}</h5>
            <ul class="list-unstyled">
              <li>ID: ${zombie.id}</li>
              <li>Name: ${zombie.name}</li>
              <li>Level: ${zombie.level}</li>
              <li>Wins: ${zombie.winCount}</li>
            </ul>
          </div>
        </div>
      </div>
    `);
        }

        $('#txStatus').text('Leaderboard loaded successfully!');
      }

      async function displayKitties() {
        $('#zombies').empty(); // Clear existing content in the zombies div (reuse it for kitties)

        // Fetch the total number of kitties
        const totalKitties = await kittyContract.methods.getKittyCount().call();

        if (totalKitties == 0) {
          $('#txStatus').text('No kitties found.');
          return;
        }

        // Loop through each kitty and display them
        for (let id = 0; id < totalKitties; id++) {
          const kitty = await kittyContract.methods.getKitty(id).call();
          const kittyImage = `https://robohash.org/${kitty.genes}?set=set4&size=150x150`;
          $('#zombies').append(`
      <div class="col-4">
        <div class="kitty card">
          <img src="${kittyImage}" class="card-img-top" alt="Kitty image">
          <div class="card-body">
            <ul class="list-unstyled">
              <li>ID: ${id}</li>
              <li>Name: ${kitty.name}</li> <!-- Added Kitty name -->
              <li>Genes: ${kitty.genes}</li>
              <li>Birth Time: ${kitty.birthTime}</li>
              <li>Generation: ${kitty.generation}</li>
              <li>Matron ID: ${kitty.matronId}</li>
              <li>Sire ID: ${kitty.sireId}</li>
            </ul>
          </div>
        </div>
      </div>
    `);
        }
      }

      async function createRandomZombie() {
        const name = prompt('Enter the name for your new zombie:');
        if (!name) {
          alert('Zombie creation canceled. No name provided.');
          return;
        }

        $('#txStatus').text(
          'Creating new zombie on the blockchain. This may take a while...',
        );
        await checkNetwork();

        if (!userAccount) {
          $('#txStatus').text(
            'No account found. Please ensure your MetaMask is connected.',
          );
          return;
        }

        return zombieOwnership.methods
          .createRandomZombie(name)
          .send({ from: userAccount, gas: 3000000 })
          .on('receipt', async function (receipt) {
            $('#txStatus').text('Successfully created ' + name + '!');

            // Fetch and log the zombie count and owner
            const zombieCount = await zombieOwnership.methods
              .getZombiesCount()
              .call();
            console.log('Zombie Count:', zombieCount);

            const lastZombieId = zombieCount - 1; // Last created zombie ID
            const zombieOwner = await zombieOwnership.methods
              .zombieToOwner(lastZombieId)
              .call();
            console.log('Zombie Owner:', zombieOwner);

            // Fetch and display zombies owned by the current user
            getZombiesByOwner(userAccount).then(displayZombies);
          })
          .on('error', function (error) {
            console.error('Error during zombie creation:', error); // Log detailed error
            $('#txStatus').text(error.message);
          });
      }

      function levelUp(zombieId) {
        $('#txStatus').text('Leveling up your zombie...');
        return zombieOwnership.methods
          .levelUp(zombieId)
          .send({
            from: userAccount,
            value: web3.utils.toWei('0.001', 'ether'),
          })
          .on('receipt', function (receipt) {
            $('#txStatus').text('Zombie successfully leveled up!');
            getZombiesByOwner(userAccount).then(displayZombies);
          })
          .on('error', function (error) {
            $('#txStatus').text(error.message);
          });
      }

      function getZombieDetails(id) {
        return zombieOwnership.methods.zombies(id).call();
      }

      function getZombiesByOwner(owner) {
        return zombieOwnership.methods.getZombiesByOwner(owner).call();
      }

      async function checkZombieCooldown(zombieId) {
        const zombie = await zombieOwnership.methods.zombies(zombieId).call();
        const now = Math.floor(Date.now() / 1000); // Get current time in seconds
        if (zombie.readyTime > now) {
          const timeLeft = zombie.readyTime - now;
          alert(`Zombie is cooling down. Please wait ${timeLeft} seconds.`);
          return false;
        }
        return true;
      }

      function attackZombie(zombieId, targetId) {
        $('#txStatus').text('Zombie attacking...');

        return zombieOwnership.methods
          .attack(zombieId, targetId)
          .send({ from: userAccount, gas: 500000 })
          .on('receipt', function (receipt) {
            $('#txStatus').text('Zombie attack complete!');
            getZombiesByOwner(userAccount).then(displayZombies);
          })
          .on('error', function (error) {
            console.error('Error during attack:', error); // Log detailed error
            $('#txStatus').text(error.message);
          });
      }

      async function levelDown(zombieId) {
        $('#txStatus').text('Leveling down your zombie...');
        try {
          await zombieOwnership.methods
            .levelDown(zombieId)
            .send({ from: userAccount, gas: 500000 });
          $('#txStatus').text('Zombie successfully leveled down!');
          getZombiesByOwner(userAccount).then(displayZombies); // Refresh zombie display
        } catch (error) {
          console.error('Error during levelDown:', error);
          $('#txStatus').text(`Error: ${error.message}`);
        }
      }

      function createKitty() {
        const name = prompt('Enter the name for your new kitty:');
        if (!name) {
          alert('Kitty creation canceled. No name provided.');
          return;
        }

        $('#txStatus').text('Creating new kitty on the blockchain...');

        kittyContract.methods
          .createKitty(name) // Pass the name instead of genes
          .send({ from: userAccount, gas: 3000000 })
          .on('receipt', function (receipt) {
            $('#txStatus').text(
              'Successfully created a new kitty with random genes!',
            );
          })
          .on('error', function (error) {
            $('#txStatus').text(error.message);
          });
      }

      async function setKittyAddress() {
        try {
          const gasEstimate = await zombieFeedingContract.methods
            .setKittyContractAddress(kittyContractAddress)
            .estimateGas({ from: userAccount });

          console.log('Estimated gas:', gasEstimate);

          await zombieFeedingContract.methods
            .setKittyContractAddress(kittyContractAddress)
            .send({ from: userAccount, gas: gasEstimate });

          $('#txStatus').text('Kitty contract address set successfully!');
        } catch (error) {
          console.error('Error setting Kitty contract address:', error);
          $('#txStatus').text(`Error: ${error.message}`);
        }
      }

      async function changeZombieDna(zombieId, newDna) {
        $('#txStatus').text('Changing DNA of your zombie...');

        // Get the user's account from MetaMask
        const userAccount = (
          await ethereum.request({ method: 'eth_accounts' })
        )[0];

        console.log('User Account retrieved from MetaMask:', userAccount);

        // Get the owner of the zombie
        const owner = await zombieOwnership.methods
          .zombieToOwner(zombieId)
          .call();
        console.log('Owner of the zombie:', owner);

        // Check if the current user is the owner
        if (owner.toLowerCase() === userAccount.toLowerCase()) {
          console.log('Ownership check passed. Proceeding to change DNA.');

          try {
            console.log('Attempting to send change DNA transaction...');
            await zombieOwnership.methods
              .changeDna(zombieId, newDna)
              .send({ from: userAccount, gas: 500000 });

            $('#txStatus').text('Zombie DNA successfully changed!');
            console.log('Zombie DNA successfully changed!');
            getZombiesByOwner(userAccount).then(displayZombies); // Refresh zombie display
          } catch (error) {
            console.error('Error during DNA change:', error);
            $('#txStatus').text(`Error: ${error.message}`);
          }
        } else {
          console.log(
            'Ownership check failed. You are not the owner of this zombie.',
          );
          $('#txStatus').text('You are not the owner of this zombie.');
        }
      }

      async function renameZombie(zombieId, newName) {
        $('#txStatus').text('Renaming your zombie...');

        const zombieDetails = await zombieOwnership.methods
          .zombies(zombieId)
          .call();
        console.log('Zombie Level:', zombieDetails.level);

        // Log that the function has been called
        console.log('renameZombie function called');
        console.log('Zombie ID:', zombieId);
        console.log('New Name:', newName);

        console.log('Zombie Details', zombieDetails);
        // Get the user's account from MetaMask
        const userAccount = (
          await ethereum.request({ method: 'eth_accounts' })
        )[0];
        console.log('User Account retrieved from MetaMask:', userAccount);

        // Check if the user is the owner of the zombie
        const zombieOwner = await zombieOwnership.methods
          .zombieToOwner(zombieId)
          .call();
        console.log('Owner of the zombie:', zombieOwner);

        // Compare owner addresses
        if (zombieOwner.toLowerCase() !== userAccount.toLowerCase()) {
          console.log(
            'Ownership mismatch! Current user does not own this zombie.',
          );
          $('#txStatus').text('You do not own this zombie.');
          return;
        }

        // Log that ownership check passed
        console.log('Ownership check passed. Proceeding to rename the zombie.');

        try {
          // Attempt to rename the zombie
          console.log('Attempting to send rename transaction...');
          await zombieOwnership.methods
            .changeName(zombieId, newName)
            .send({ from: userAccount, gas: 1000000 });

          // Log successful transaction
          console.log('Transaction successful! Zombie renamed.');
          $('#txStatus').text('Zombie renamed successfully!');

          // Fetch updated zombie list
          getZombiesByOwner(userAccount).then(displayZombies);
        } catch (error) {
          // Log the error in case of failure
          console.error('Error during renaming:', error);
          $('#txStatus').text(`Error: ${error.message}`);
        }

        // Log that the function has completed
        console.log('renameZombie function completed.');
      }

      async function transferContractOwnership() {
        try {
          const ownerAddress = await zombieFeedingContract.methods
            .owner()
            .call();
          console.log('Contract owner:', ownerAddress);
          console.log('Current user:', userAccount);

          // Ensure the current user is the contract owner
          if (userAccount.toLowerCase() === ownerAddress.toLowerCase()) {
            // Prompt for the new owner address
            const newOwnerAddress = prompt('Enter the new owner address:');

            if (newOwnerAddress) {
              // Transfer ownership to the provided address
              await zombieFeedingContract.methods
                .transferOwnership(newOwnerAddress)
                .send({ from: userAccount }); // Use `userAccount` to sign the transaction

              console.log('Ownership transferred successfully');
              $('#txStatus').text('Ownership transferred successfully!');
            } else {
              console.log('New owner address was not provided.');
              $('#txStatus').text('New owner address was not provided.');
            }
          } else {
            console.log('You are not the contract owner.');
            $('#txStatus').text('You are not the contract owner.');
          }
        } catch (error) {
          console.error('Error transferring ownership:', error);
          $('#txStatus').text(`Error transferring ownership: ${error.message}`);
        }
      }

      async function checkZombieLevel(zombieId) {
        const zombie = await zombieOwnership.methods.zombies(zombieId).call();
        return zombie.level >= 20;
      }

      // Add event listener to the button
      transferOwnershipButton.addEventListener('click', async () => {
        await transferContractOwnership();
      });

      // You can invoke this function when needed, for example, after the contracts are initialized or via a button click.

      // Event listener for the createKittyButton
      createKittyButton.addEventListener('click', async () => {
        await checkNetwork();
        createKitty();
      });

      showKittiesButton.addEventListener('click', async () => {
        await checkNetwork();
        displayKitties();
      });

      // Event listeners for buttons
      // feedZombieButton.addEventListener('click', () => {
      //   const zombieId = prompt('Enter the Zombie ID to feed on kitty:');
      //   const kittyId = prompt('Enter the Kitty ID:');
      //   if (zombieId && kittyId) {
      //     feedOnKitty(zombieId, kittyId);
      //   }
      // });

      transferZombieButton.addEventListener('click', () => {
        const zombieId = prompt('Enter the Zombie ID to transfer:');
        const recipient = prompt('Enter the recipient address:');
        if (zombieId && recipient) {
          transferZombie(zombieId, recipient);
        }
      });

      // zombieFeedingContract.events.OwnershipCheck({}, function (error, event) {
      //   if (error) {
      //     console.error('Error in OwnershipCheck event:', error);
      //   } else {
      //     console.log('OwnershipCheck event:', event.returnValues);
      //   }
      // });

      battleZombieButton.addEventListener('click', () => {
        const zombieId = parseInt(
          prompt('Enter the Zombie ID for battle:'),
          10,
        );
        const targetId = parseInt(
          prompt('Enter the target Zombie ID to attack:'),
          10,
        );

        if (isNaN(zombieId) || isNaN(targetId)) {
          alert('Invalid input! Please enter valid zombie and target IDs.');
          return;
        }

        // Proceed with the attack if inputs are valid
        attackZombie(zombieId, targetId);
      });

      leveldownButton.addEventListener('click', () => {
        const zombieId = prompt('Enter the Zombie ID to level down:');
        if (zombieId) {
          levelDown(zombieId);
        }
      });

      changeDnaButton.addEventListener('click', async () => {
        const zombieId = prompt('Enter the Zombie ID to change DNA:');
        const newDna = prompt('Enter the new DNA (numeric):');

        if (zombieId && newDna) {
          const isAboveLevel20 = await checkZombieLevel(zombieId);

          if (isAboveLevel20) {
            changeZombieDna(zombieId, newDna);
          } else {
            alert('Zombie must be at least level 20 to change DNA.');
          }
        }
      });

      renameZombieButton.addEventListener('click', () => {
        const zombieId = prompt('Enter the Zombie ID to rename:');
        const newName = prompt('Enter the new name:');
        if (zombieId && newName) {
          renameZombie(zombieId, newName);
        }
      });

      window.addEventListener('load', async () => {
        if (window.ethereum) {
          window.web3 = new Web3(ethereum);
          try {
            const accounts = await ethereum.request({
              method: 'eth_requestAccounts',
            });

            const balance1 = await web3.eth.getBalance(accounts[0]);
            const balance2 = await web3.eth.getBalance(accounts[1]);

            if (balance2 > 0) {
              userAccount = accounts[1];
            } else if (balance1 > 0) {
              userAccount = accounts[0];
            } else {
              alert('Neither account has ETH. Please fund your account.');
              return;
            }

            if (!userAccount) {
              $('#txStatus').text(
                'MetaMask is connected but no account selected with balance.',
              );
              return;
            }

            startApp();
          } catch (error) {
            $('#txStatus').text(
              'Error connecting to MetaMask. Please ensure MetaMask is installed and connected.',
            );
          }
        } else if (window.web3) {
          window.web3 = new Web3(web3.currentProvider);
          const accounts = await web3.eth.getAccounts();
          userAccount = accounts[1];
          startApp();
        } else {
          $('#txStatus').text(
            'Non-Ethereum browser detected. Please install MetaMask.',
          );
        }
      });

      ethereum.on('accountsChanged', accounts => {
        if (accounts.length > 1) {
          userAccount = accounts[1];
        } else {
          userAccount = accounts[0];
        }
        window.location.reload();
      });

      ethereum.on('chainChanged', () => {
        window.location.reload();
      });

      createzombieButton.addEventListener('click', async () => {
        await checkNetwork();
        createRandomZombie();
      });

      showZombieButton.addEventListener('click', async () => {
        await checkNetwork();
        getZombiesByOwner(userAccount).then(displayZombies);
      });

      showZombieCountButton.addEventListener('click', showZombieCount);
      // showKittyContractAddressButton.addEventListener(
      //   'click',
      //   showKittyContractAddress,
      // );

      leaderboardButton.addEventListener('click', async () => {
        await checkNetwork();
        displayLeaderboard();
      });

      levelupButton.addEventListener('click', () => {
        const zombieId = prompt('Enter the Zombie ID to level up:');
        if (zombieId) {
          levelUp(zombieId);
        }
      });
    </script>
  </body>
</html>
